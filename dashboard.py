import io
import re
import json
import base64
from typing import List, Tuple

import streamlit as st
from PyPDF2 import PdfReader
from google.cloud import storage
from google.oauth2 import service_account
import google.generativeai as genai
from tenacity import retry, stop_after_attempt, wait_exponential

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ê¸°ë³¸ ì„¤ì •
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.set_page_config(page_title="PDF â†’ ê¸°ì‚¬ë³„ 3ì¤„ ìš”ì•½ (Gemini 2.0 Flash)", layout="wide")
st.title("ğŸ“„ PDF ì—…ë¡œë“œ â†’ ê¸°ì‚¬ë³„ 3ì¤„ ìš”ì•½ (gemini-2.0-flash@001)")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ì‹œí¬ë¦¿ ë¡œë“œ & ì•ˆì „ ì²´í¬
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
missing = []
gemini_key   = st.secrets.get("GEMINI_API_KEY") or missing.append("GEMINI_API_KEY")
gcs_b64      = st.secrets.get("GCS_SA_KEY_B64") or missing.append("GCS_SA_KEY_B64")
bucket_name  = st.secrets.get("GCS_BUCKET_NAME") or missing.append("GCS_BUCKET_NAME")

if missing:
    st.error(f"Secretsì— {', '.join(missing)} ê°€ ì—†ìŠµë‹ˆë‹¤. Manage app â†’ Settings â†’ Secrets ì— ë“±ë¡í•˜ì„¸ìš”.")
    st.stop()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# GCS í´ë¼ì´ì–¸íŠ¸
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
gcs_info   = json.loads(base64.b64decode(gcs_b64))
gcs_creds  = service_account.Credentials.from_service_account_info(gcs_info)
gcs_client = storage.Client(credentials=gcs_creds, project=gcs_info["project_id"])
bucket     = gcs_client.bucket(bucket_name)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Gemini ì„¤ì •
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
genai.configure(api_key=gemini_key)
MODEL_ID = "gemini-2.0-flash-001"
model    = genai.GenerativeModel(MODEL_ID)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ìœ í‹¸ í•¨ìˆ˜: GCS
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def list_pdfs() -> List[str]:
    return [
        b.name.split("/", 1)[1]
        for b in gcs_client.list_blobs(bucket_name, prefix="pdfs/")
        if b.name.endswith(".pdf")
    ]

def upload_pdf(name: str, data: bytes):
    bucket.blob(f"pdfs/{name}").upload_from_file(io.BytesIO(data), content_type="application/pdf")

def download_pdf(name: str) -> bytes:
    return bucket.blob(f"pdfs/{name}").download_as_bytes()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# í…ìŠ¤íŠ¸ ë¶„ë¦¬ ë¡œì§: ê¸°ì‚¬ ë‹¨ìœ„ë¡œ ë‚˜ëˆ„ê¸°
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def split_articles(raw_text: str) -> List[str]:
    """
    ë§¤ìš° ë‹¨ìˆœí•œ íœ´ë¦¬ìŠ¤í‹±:
      1) íŠ¹ìˆ˜ ê¸°í˜¸(â– â–²â–¶â—†â–¡) ì•ì— ë¹ˆ ì¤„ ì‚½ì…
      2) ë¹ˆ ì¤„ 2ê°œ ì´ìƒ ê¸°ì¤€ìœ¼ë¡œ ë¶„ë¦¬
      3) ë„ˆë¬´ ì§§ì€ ì¡°ê° ì œì™¸
    í”„ë¡œì íŠ¸ ë°ì´í„° íŠ¹ì„±ì— ë§ì¶° ì •ê·œì‹ì€ ì¡°ì •í•˜ì„¸ìš”.
    """
    # ê¸°í˜¸ë¥¼ ê¸°ì‚¬ êµ¬ë¶„ìë¡œ ì‚¬ìš© (í•„ìš”ì‹œ ì¶”ê°€)
    text = re.sub(r"[â– â–²â–¶â—†â–¡]\s*", "\n\n", raw_text)
    # ë¹ˆ ì¤„ 2ê°œ ì´ìƒì„ ê¸°ì¤€ìœ¼ë¡œ split
    chunks = re.split(r"\n\s*\n\s*\n+", text)
    # ê¸¸ì´ê°€ ë„ˆë¬´ ì§§ì€ ì¡°ê° ì œê±° (120ì ê¸°ì¤€ ì„ì˜ ì„¤ì •)
    articles = [c.strip() for c in chunks if len(c.strip()) > 120]
    return articles

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Gemini ìš”ì•½ í˜¸ì¶œ (ì¬ì‹œë„ í¬í•¨)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@retry(reraise=True, stop=stop_after_attempt(4), wait=wait_exponential(min=1, max=6))
def summarize_with_gemini(prompt: str) -> str:
    resp = model.generate_content(
        prompt,
        generation_config={"temperature": 0.3, "max_output_tokens": 256},
    )
    return (resp.text or "").strip()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# PDF â†’ ê¸°ì‚¬ë³„ í…ìŠ¤íŠ¸ ì¶”ì¶œ & ìš”ì•½
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def summarize_pdf_bytes(pdf_bytes: bytes) -> List[Tuple[int, str, str]]:
    """
    return: [(ê¸°ì‚¬ë²ˆí˜¸, ë¯¸ë¦¬ë³´ê¸°í…ìŠ¤íŠ¸, ìš”ì•½ë¬¸)]
    """
    reader = PdfReader(io.BytesIO(pdf_bytes))
    raw = "".join((p.extract_text() or "") for p in reader.pages)
    if not raw.strip():
        return []

    articles = split_articles(raw)
    results  = []

    for idx, art in enumerate(articles, 1):
        # í† í° ë¹„ìš© ì ˆì•½: ê¸°ì‚¬ ë³¸ë¬¸ë„ ë„ˆë¬´ ê¸¸ë©´ ì•ë¶€ë¶„ë§Œ
        clipped = art[:2000]
        prompt  = (
            "ë‹¤ìŒ ê¸°ì‚¬ ë‚´ìš©ì„ 3ì¤„ ì´ë‚´ë¡œ ìš”ì•½í•´ ì£¼ì„¸ìš”.\n"
            "ì¡°ê±´:\n"
            "1. í•µì‹¬ ì‚¬ì‹¤/ìˆ˜ì¹˜/ì£¼ì²´ë§Œ ë‚¨ê¸°ê³  êµ°ë”ë”ê¸° ì œê±°\n"
            "2. ì¤„ë°”ê¿ˆìœ¼ë¡œ 3ì¤„ì„ ëª…í™•íˆ êµ¬ë¶„\n\n"
            f"{clipped}"
        )
        try:
            summary = summarize_with_gemini(prompt)
        except Exception as e:
            summary = f"ìš”ì•½ ì‹¤íŒ¨: {type(e).__name__}: {e}"
        preview = art[:150].replace("\n", " ")
        results.append((idx, preview, summary))

    return results

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# UI: PDF ì—…ë¡œë“œ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.sidebar.header("ğŸ“¤ PDF ì—…ë¡œë“œ")
uploaded = st.sidebar.file_uploader("PDF íŒŒì¼ ì„ íƒ", type="pdf")
if uploaded:
    upload_pdf(uploaded.name, uploaded.read())
    st.sidebar.success(f"âœ… GCSì— ì €ì¥ë¨: {uploaded.name}")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# UI: ëª©ë¡ & ê¸°ì‚¬ë³„ 3ì¤„ ìš”ì•½
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.header("ğŸ“‘ ì €ì¥ëœ PDF â†’ ê¸°ì‚¬ë³„ 3ì¤„ ìš”ì•½")
pdfs = list_pdfs()

if not pdfs:
    st.info("GCS ë²„í‚·ì˜ pdfs/ í´ë”ì— PDFë¥¼ ì—…ë¡œë“œí•´ ë³´ì„¸ìš”.")
else:
    for name in sorted(pdfs):
        st.subheader(name)
        if st.button(f"ìš”ì•½: {name}", key=name):
            data = download_pdf(name)
            with st.spinner("ìš”ì•½ ìƒì„± ì¤‘â€¦"):
                items = summarize_pdf_bytes(data)

            if not items:
                st.warning("í…ìŠ¤íŠ¸ ì¶”ì¶œì— ì‹¤íŒ¨í–ˆê±°ë‚˜ ê¸°ì‚¬ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")
            else:
                for idx, preview, summary in items:
                    with st.expander(f"ê¸°ì‚¬ #{idx}  |  ë¯¸ë¦¬ë³´ê¸°: {preview} ..."):
                        st.text_area("ìš”ì•½ (3ì¤„)", summary, height=150)
        st.markdown("---")
